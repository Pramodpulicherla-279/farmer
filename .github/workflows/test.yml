name: Android APK Testing
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # Set up Java and Android SDK
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # Create and start emulator
      - name: Create and start emulator
        run: |
          echo "y" | sdkmanager "platform-tools" "emulator"
          echo "y" | sdkmanager "system-images;android-31;google_apis;x86_64"
          echo "no" | avdmanager create avd \
            --name "test_avd" \
            --package "system-images;android-31;google_apis;x86_64" \
            --device "pixel_6_pro" \
            --force
          emulator -avd test_avd -no-window -no-audio -no-snapshot -camera-back none -camera-front none &
          adb wait-for-device
          echo "Emulator started successfully"

      # Wait for emulator to be fully booted
      - name: Wait for emulator boot
        run: |
          adb wait-for-device
          while [ "$(adb shell getprop sys.boot_completed | tr -d '\r')" != "1" ]; do
            echo "Waiting for emulator to boot..."
            sleep 5
          done
          echo "Emulator is ready"

      # Set up Node.js and dependencies
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g appium
          npm install
          npm install -g allure-commandline

      # Install APK
      - name: Install APK
        run: |
          adb install -t ./Krishivaas_Farmer.apk
          adb shell pm list packages | grep com.krishivaas

      # Run WebdriverIO tests
      - name: Run Tests
        env:
          APPIUM_PORT: 4723
        run: |
          # Start Appium server in background
          nohup appium --log-level info --relaxed-security > appium.log 2>&1 &
          
          # Wait for Appium to start
          sleep 10
          
          # Run tests
          npx wdio run wdio.conf.js || true
          
          # Save logs
          mkdir -p test-results
          cp appium.log test-results/
          adb logcat -d > test-results/logcat.log

      # Process test results
      - name: Process results
        if: always()
        run: |
          # Generate Allure report
          allure generate allure-results --clean -o allure-report
          
          # Check for test failures
          if grep -q "failed" wdio.log; then
            echo "::warning::Some tests failed"
          fi

      # Upload artifacts
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            allure-report/
            test-results/
            screenshots/
            wdio.log

      # Clean up
      - name: Stop emulator
        if: always()
        run: |
          adb emu kill
          pkill -f "emulator"